<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administracyjny - Kwiaciarnia Lilia</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            font-size: 13px;
            color: #666;
        }
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .category-tab {
            padding: 12px 24px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        .category-tab.active {
            background: #333;
            color: white;
            border-color: #333;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .product-card-admin {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .product-card-admin img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f0f0f0;
        }
        .product-card-admin .no-image {
            width: 100%;
            height: 180px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }
        .product-card-admin .content {
            padding: 15px;
            background: white !important;
            color: #333 !important;
        }
        .product-card-admin h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #333 !important;
        }
        .product-card-admin .price-display {
            font-size: 20px;
            font-weight: bold;
            color: #333 !important;
            margin: 10px 0;
        }
        .product-card-admin .type-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #e0e0e0 !important;
            color: #333 !important;
            border-radius: 3px;
            font-size: 11px;
            margin-bottom: 10px;
        }
        .product-card-admin .quiz-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 10px 0;
        }
        .product-card-admin .quiz-tag {
            padding: 2px 6px;
            background: #e8f4e8 !important;
            border-radius: 3px;
            font-size: 10px;
            color: #2e7d32 !important;
        }
        .product-card-admin .kwiatomat-badge {
            background: #333 !important;
            color: white !important;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        .product-card-admin .actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .product-card-admin .actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            background: #333 !important;
            color: white !important;
            border: none;
            cursor: pointer;
        }
        .product-card-admin .actions button:hover {
            background: #555 !important;
        }

        /* Modal edycji */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        .edit-modal.show {
            display: block;
        }
        .edit-modal-content {
            background: white;
            color: #333;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 4px;
            position: relative;
        }
        .edit-modal-content h3,
        .edit-modal-content h4,
        .edit-modal-content label,
        .edit-modal-content p {
            color: #333;
        }
        .edit-modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        .edit-modal h3 {
            margin-bottom: 20px;
        }
        .edit-modal .product-preview {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .edit-modal .product-preview img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            background: #f0f0f0;
        }
        .image-upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }
        .image-upload-btn:hover {
            background: #555;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            color: #333;
        }
        .form-group input[type="number"] {
            font-size: 18px;
            font-weight: bold;
        }
        .quiz-tags-section {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .quiz-tags-section h4 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #555;
        }
        .quiz-tags-section label {
            color: #333 !important;
        }
        .checkbox-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        .checkbox-inline input {
            width: auto;
        }
        .save-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            margin-top: 20px;
            background: #333 !important;
            color: white !important;
            border: none;
            cursor: pointer;
        }
        .save-btn:hover {
            background: #555 !important;
        }

        /* Filtry */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .filters-bar input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Banner sezonowy -->
    <div class="seasonal-banner" id="seasonalBanner"></div>

    <header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="assets/images/branding/logo.png" alt="Kwiaciarnia Lilia">
                <span style="font-size: 0.8em; margin-left: 10px; color: #8B4513;">Admin</span>
            </a>
            <nav>
                <ul>
                    <li><a href="index.html">Strona g≈Ç√≥wna</a></li>
                    <li><a href="sklep.html">Sklep</a></li>
                    <li><a href="wyslij-kwiaty.html">Wy≈õlij kwiaty</a></li>
                    <li><a href="quiz.html">Quiz</a></li>
                    <li><a href="abonament.html">Abonament</a></li>
                    <li><a href="galeria.html">Galeria</a></li>
                    <li><a href="poradnik.html">Poradnik</a></li>
                    <li><a href="kwiatomat.html">Kwiatomat</a></li>
                    <li><a href="kontakt.html">Kontakt</a></li>
                    <li><a href="admin.html" style="color: #8B4513; font-weight: bold;">Admin</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="section">
        <div class="admin-container">
            <h1>Panel zarzƒÖdzania produktami</h1>

            <!-- Banner sezonowy - zarzƒÖdzanie -->
            <div class="banner-manager" style="background: #2a2520; padding: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.1rem;">üéâ Banner sezonowy</h3>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <span style="font-size: 0.9rem;">W≈ÇƒÖczony</span>
                        <input type="checkbox" id="bannerEnabled" onchange="saveBannerSettings()" style="width: 20px; height: 20px;">
                    </label>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #aaa;">Tre≈õƒá bannera</label>
                        <input type="text" id="bannerText" placeholder="üíê Walentynki ju≈º 14 lutego!..." onchange="saveBannerSettings()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #aaa;">Tekst linku</label>
                        <input type="text" id="bannerLinkText" placeholder="Zam√≥w teraz ‚Üí" onchange="saveBannerSettings()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white;">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #aaa;">Link URL</label>
                    <input type="text" id="bannerLinkUrl" placeholder="sklep.html?category=occasional" onchange="saveBannerSettings()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white;">
                </div>
                <div id="bannerPreview" style="margin-top: 15px; padding: 12px; background: linear-gradient(90deg, #8B0000, #B22222, #8B0000); text-align: center; font-size: 0.95rem;">
                    <!-- PodglƒÖd bannera -->
                </div>
            </div>

            <!-- Statystyki -->
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div class="stat-label">Wszystkich produkt√≥w</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="occasionalProducts">0</div>
                    <div class="stat-label">Okoliczno≈õciowych</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="funeralProducts">0</div>
                    <div class="stat-label">Pogrzebowych</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="kwiatomatProducts">0</div>
                    <div class="stat-label">W kwiatomacie</div>
                </div>
            </div>

            <!-- Zak≈Çadki kategorii -->
            <div class="category-tabs">
                <button class="category-tab active" onclick="switchCategory('occasional')">Okoliczno≈õciowe</button>
                <button class="category-tab" onclick="switchCategory('funeral')">Pogrzebowe</button>
            </div>

            <!-- Filtry -->
            <div class="filters-bar">
                <button class="button" onclick="addNewProduct()" style="background: #4a7c59;">+ Dodaj produkt</button>
                <select id="typeFilter" onchange="applyFilters()">
                    <option value="">Wszystkie typy</option>
                </select>
                <input type="text" id="searchFilter" placeholder="Szukaj po nazwie..." oninput="applyFilters()">
                <button class="button secondary" onclick="resetProducts()">Resetuj do domy≈õlnych</button>
                <button class="button secondary" onclick="exportProducts()">Eksportuj JSON</button>
            </div>

            <!-- Siatka produkt√≥w -->
            <div id="productGrid" class="product-grid">
                <!-- Produkty bƒôdƒÖ wstawiane dynamicznie -->
            </div>
        </div>
    </section>

    <!-- Modal edycji/dodawania produktu -->
    <div id="editModal" class="edit-modal">
        <div class="edit-modal-content">
            <span class="edit-modal-close" onclick="closeEditModal()">&times;</span>
            <h3 id="modalTitle">Edytuj produkt</h3>

            <div class="product-preview">
                <div style="position: relative;">
                    <img id="editPreviewImage" src="" alt="PodglƒÖd">
                    <label for="editImageFile" class="image-upload-btn">Zmie≈Ñ zdjƒôcie</label>
                    <input type="file" id="editImageFile" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">
                </div>
                <div style="flex: 1;">
                    <h4 id="editPreviewName">Nazwa produktu</h4>
                    <div id="editPreviewType" class="type-badge">Typ</div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label style="font-size: 11px;">≈öcie≈ºka do zdjƒôcia:</label>
                        <input type="text" id="editImagePath" style="font-size: 11px; padding: 5px;" placeholder="assets/images/..." onchange="updateImagePreview()">
                    </div>
                    <p style="font-size: 10px; color: #888; margin-top: 5px;">Wgraj nowe zdjƒôcie lub wpisz ≈õcie≈ºkƒô do istniejƒÖcego</p>
                </div>
            </div>

            <form id="editForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="editProductId">

                <div class="form-row">
                    <div class="form-group">
                        <label>Nazwa produktu</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label>Cena (z≈Ç)</label>
                        <input type="number" id="editPrice" min="0" step="1" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Typ produktu</label>
                        <select id="editType">
                            <optgroup label="Pogrzebowe">
                                <option value="wieniec">Wieniec</option>
                                <option value="wiazanka-bukiet">Bukiet do rƒôki</option>
                                <option value="wiazanka-floret">WiƒÖzanka na florecie</option>
                            </optgroup>
                            <optgroup label="Okoliczno≈õciowe">
                                <option value="box-zywy">Flower Box</option>
                                <option value="bukiet-zywy">Bukiet ≈ºywy</option>
                                <option value="bukiet-jadalny">Bukiet jadalny</option>
                                <option value="wieczna-roza">Wieczna r√≥≈ºa</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kategoria</label>
                        <select id="editCategory">
                            <option value="funeral">Pogrzebowe</option>
                            <option value="occasional">Okoliczno≈õciowe</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Opis</label>
                    <textarea id="editDescription" rows="2"></textarea>
                </div>

                <!-- Tagi quizu - tylko dla okoliczno≈õciowych -->
                <div id="quizTagsSection" class="quiz-tags-section">
                    <h4>Tagi do quizu (tylko okoliczno≈õciowe)</h4>
                    <p style="font-size: 11px; color: #888; margin-bottom: 15px;">Wybierz tagi pasujƒÖce do produktu. Mo≈ºesz wybraƒá wiele opcji przytrzymujƒÖc Ctrl/Cmd.</p>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Okazja</label>
                            <select id="editOccasion" multiple size="4">
                                <option value="romantyczna">Romantyczna (randka, rocznica)</option>
                                <option value="uroczysta">Uroczysta (urodziny, imieniny)</option>
                                <option value="oficjalna">Oficjalna (podziƒôkowanie)</option>
                                <option value="bezOkazji">Bez okazji</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Osobowo≈õƒá</label>
                            <select id="editPersonality" multiple size="3">
                                <option value="klasyka">Klasyka i natura</option>
                                <option value="nowoczesnosc">Nowoczesno≈õƒá i styl</option>
                                <option value="praktycznosc">Praktyczno≈õƒá</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Priorytet</label>
                            <select id="editPriority" multiple size="3">
                                <option value="wow">Efekt WOW</option>
                                <option value="trwalosc">Trwa≈Ço≈õƒá</option>
                                <option value="symboliczny">Symboliczny gest</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kolorystyka</label>
                            <select id="editColor" multiple size="3">
                                <option value="czerwien">Czerwie≈Ñ / Mi≈Ço≈õƒá</option>
                                <option value="pastele">Jasne / Pastele / R√≥≈º</option>
                                <option value="kolorowo">Kolorowo / Mix</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="checkbox-inline">
                    <input type="checkbox" id="editKwiatomat">
                    <label for="editKwiatomat">Dostƒôpny w kwiatomacie 24/7</label>
                </div>

                <button type="submit" class="button save-btn">Zapisz zmiany</button>
            </form>
        </div>
    </div>

    <footer>
        <div class="container">
            <div style="display: flex; align-items: center; gap: 30px; flex-wrap: wrap;">
                <img src="assets/images/branding/logo.png" alt="Kwiaciarnia Lilia" style="height: 80px; width: auto;">
                <div style="flex: 1; text-align: left;">
                    <p style="margin-bottom: 5px;">Kwiaciarnia Lilia - Myszk√≥w ‚Ä¢ ul. Krasickiego 95F ‚Ä¢ Tel. +48 572 429 000</p>
                    <p style="margin: 0;">NIP 5732704306 ‚Ä¢ ¬© 2025 Lilia ‚Ä¢ Panel Administracyjny</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="assets/js/products.js"></script>
    <script>
        let allProducts = [];
        let currentCategory = 'occasional';

        // Mapowanie typ√≥w na czytelne nazwy
        const typeLabels = {
            'box-zywy': 'Flower Box',
            'bukiet-zywy': 'Bukiet ≈ºywy',
            'bukiet-jadalny': 'Bukiet jadalny',
            'wieczna-roza': 'Wieczna r√≥≈ºa',
            'wieniec': 'Wieniec',
            'wiazanka-bukiet': 'Bukiet do rƒôki',
            'wiazanka-floret': 'WiƒÖzanka floret'
        };

        const occasionLabels = {
            'romantyczna': 'Romantyczna',
            'uroczysta': 'Uroczysta',
            'oficjalna': 'Oficjalna',
            'bezOkazji': 'Bez okazji'
        };

        const personalityLabels = {
            'klasyka': 'Klasyka',
            'nowoczesnosc': 'Nowoczesno≈õƒá',
            'praktycznosc': 'Praktyczno≈õƒá'
        };

        const priorityLabels = {
            'wow': 'WOW',
            'trwalosc': 'Trwa≈Ço≈õƒá',
            'symboliczny': 'Symboliczny'
        };

        const colorLabels = {
            'czerwien': 'Czerwie≈Ñ',
            'pastele': 'Pastele',
            'kolorowo': 'Kolorowo'
        };

        // Pomocnicza funkcja - formatuj tagi (obs≈Çuguje string lub tablicƒô)
        function formatTagValues(value, labels) {
            if (!value) return '';
            const values = Array.isArray(value) ? value : [value];
            return values.map(v => labels[v] || v).join(', ');
        }

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            updateStats();
            updateTypeFilter();
            renderProducts();
            loadBannerSettings();
        });

        // ========== BANNER SEZONOWY ==========

        // Za≈Çaduj ustawienia bannera
        function loadBannerSettings() {
            const settings = JSON.parse(localStorage.getItem('liliaBanner') || '{}');

            document.getElementById('bannerEnabled').checked = settings.enabled !== false;
            document.getElementById('bannerText').value = settings.text || 'üíê Walentynki ju≈º 14 lutego! Zam√≥w bukiet z wyprzedzeniem i zyskaj darmowƒÖ dostawƒô';
            document.getElementById('bannerLinkText').value = settings.linkText || 'Zam√≥w teraz ‚Üí';
            document.getElementById('bannerLinkUrl').value = settings.linkUrl || 'sklep.html?category=occasional';

            updateBannerPreview();
        }

        // Zapisz ustawienia bannera
        function saveBannerSettings() {
            const settings = {
                enabled: document.getElementById('bannerEnabled').checked,
                text: document.getElementById('bannerText').value,
                linkText: document.getElementById('bannerLinkText').value,
                linkUrl: document.getElementById('bannerLinkUrl').value
            };

            localStorage.setItem('liliaBanner', JSON.stringify(settings));
            updateBannerPreview();
        }

        // Aktualizuj podglƒÖd bannera
        function updateBannerPreview() {
            const enabled = document.getElementById('bannerEnabled').checked;
            const text = document.getElementById('bannerText').value || 'Tre≈õƒá bannera...';
            const linkText = document.getElementById('bannerLinkText').value || 'Link';

            const preview = document.getElementById('bannerPreview');
            preview.style.opacity = enabled ? '1' : '0.4';
            preview.innerHTML = `${text} <a href="#" style="color: white; text-decoration: underline; font-weight: 600; margin-left: 10px;">${linkText}</a>`;
        }

        // Za≈Çaduj produkty
        function loadProducts() {
            // Sprawd≈∫ czy sƒÖ zapisane w localStorage
            const stored = localStorage.getItem('liliaProducts');
            if (stored) {
                allProducts = JSON.parse(stored);
            } else {
                // U≈ºyj domy≈õlnych z products.js
                allProducts = getProducts();
                saveToLocalStorage();
            }
        }

        // Zapisz do localStorage
        function saveToLocalStorage() {
            localStorage.setItem('liliaProducts', JSON.stringify(allProducts));
            // Zaktualizuj wersjƒô ≈ºeby sklep te≈º za≈Çadowa≈Ç nowe dane
            localStorage.setItem('liliaProductsVersion', 'admin-' + Date.now());
        }

        // Prze≈ÇƒÖcz kategoriƒô
        function switchCategory(category) {
            currentCategory = category;

            // Aktualizuj zak≈Çadki
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            updateTypeFilter();
            renderProducts();
        }

        // Aktualizuj filtr typ√≥w
        function updateTypeFilter() {
            const filter = document.getElementById('typeFilter');
            const types = [...new Set(allProducts
                .filter(p => p.category === currentCategory)
                .map(p => p.type))];

            filter.innerHTML = '<option value="">Wszystkie typy</option>' +
                types.map(t => `<option value="${t}">${typeLabels[t] || t}</option>`).join('');
        }

        // Zastosuj filtry
        function applyFilters() {
            renderProducts();
        }

        // Renderuj produkty
        function renderProducts() {
            const grid = document.getElementById('productGrid');
            const typeFilter = document.getElementById('typeFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            let filtered = allProducts.filter(p => p.category === currentCategory);

            if (typeFilter) {
                filtered = filtered.filter(p => p.type === typeFilter);
            }

            if (searchFilter) {
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(searchFilter) ||
                    p.description.toLowerCase().includes(searchFilter)
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">Brak produkt√≥w w tej kategorii</p>';
                return;
            }

            grid.innerHTML = filtered.map(product => {
                let quizTagsHtml = '';
                if (product.quizTags) {
                    const tags = [];
                    if (product.quizTags.occasion) tags.push(formatTagValues(product.quizTags.occasion, occasionLabels));
                    if (product.quizTags.personality) tags.push(formatTagValues(product.quizTags.personality, personalityLabels));
                    if (product.quizTags.priority) tags.push(formatTagValues(product.quizTags.priority, priorityLabels));
                    if (product.quizTags.color) tags.push(formatTagValues(product.quizTags.color, colorLabels));

                    quizTagsHtml = tags.length > 0 ? `
                        <div class="quiz-tags">
                            ${tags.filter(t => t).map(t => `<span class="quiz-tag">${t}</span>`).join('')}
                        </div>
                    ` : '';
                }

                const kwiatomatHtml = product.kwiatomatAvailable
                    ? '<span class="kwiatomat-badge">Kwiatomat</span>'
                    : '';

                const imageHtml = product.image
                    ? `<img src="${product.image}" alt="${product.name}" onerror="this.outerHTML='<div class=\\'no-image\\'>[brak zdjƒôcia]</div>'">`
                    : '<div class="no-image">[brak zdjƒôcia]</div>';

                const priceDisplay = product.sizeOptions
                    ? `od ${Math.min(...product.sizeOptions.map(o => o.price))} z≈Ç`
                    : `${product.price} z≈Ç`;

                return `
                    <div class="product-card-admin">
                        ${imageHtml}
                        <div class="content">
                            <span class="type-badge">${typeLabels[product.type] || product.type}</span>
                            ${kwiatomatHtml}
                            <h4>${product.name}</h4>
                            <div class="price-display">${priceDisplay}</div>
                            ${quizTagsHtml}
                            <div class="actions">
                                <button class="button" onclick="editProduct(${product.id})">Edytuj</button>
                                <button class="button" onclick="deleteProduct(${product.id})" style="background: #c0392b;">Usu≈Ñ</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Obs≈Çuga uploadu zdjƒôcia
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // Poka≈º podglƒÖd
                document.getElementById('editPreviewImage').src = e.target.result;
                // Zapisz jako base64 w polu ≈õcie≈ºki
                document.getElementById('editImagePath').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Aktualizuj podglƒÖd gdy zmieni siƒô ≈õcie≈ºka
        function updateImagePreview() {
            const path = document.getElementById('editImagePath').value;
            if (path) {
                document.getElementById('editPreviewImage').src = path;
            }
        }

        // Dodaj nowy produkt
        function addNewProduct() {
            // Znajd≈∫ najwy≈ºsze ID
            const maxId = allProducts.reduce((max, p) => Math.max(max, p.id), 0);
            const newId = maxId + 1;

            // Ustaw tytu≈Ç modala
            document.getElementById('modalTitle').textContent = 'Dodaj nowy produkt';

            // Wyczy≈õƒá formularz
            document.getElementById('editProductId').value = newId;
            document.getElementById('editName').value = '';
            document.getElementById('editPrice').value = '';
            document.getElementById('editDescription').value = '';
            document.getElementById('editKwiatomat').checked = false;
            document.getElementById('editType').value = currentCategory === 'funeral' ? 'wieniec' : 'box-zywy';
            document.getElementById('editCategory').value = currentCategory;

            // Wyczy≈õƒá podglƒÖd zdjƒôcia
            document.getElementById('editPreviewImage').src = 'assets/images/branding/logo.png';
            document.getElementById('editImagePath').value = '';
            document.getElementById('editPreviewName').textContent = 'Nowy produkt';
            document.getElementById('editPreviewType').textContent = currentCategory === 'funeral' ? 'Wieniec' : 'Flower Box';

            // Tagi quizu
            const quizSection = document.getElementById('quizTagsSection');
            if (currentCategory === 'occasional') {
                quizSection.style.display = 'block';
                ['editOccasion', 'editPersonality', 'editPriority', 'editColor'].forEach(id => {
                    Array.from(document.getElementById(id).options).forEach(opt => opt.selected = false);
                });
            } else {
                quizSection.style.display = 'none';
            }

            // Nas≈Çuchuj zmiany kategorii
            document.getElementById('editCategory').onchange = function() {
                document.getElementById('quizTagsSection').style.display =
                    this.value === 'occasional' ? 'block' : 'none';
            };

            // Reset inputa pliku
            document.getElementById('editImageFile').value = '';

            // Poka≈º modal
            document.getElementById('editModal').classList.add('show');
        }

        // Edytuj produkt
        function editProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) {
                alert('Nie znaleziono produktu o ID: ' + id);
                return;
            }

            // Ustaw tytu≈Ç modala
            document.getElementById('modalTitle').textContent = 'Edytuj produkt';

            // Wype≈Çnij formularz
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editName').value = product.name;
            document.getElementById('editPrice').value = product.price;
            document.getElementById('editDescription').value = product.description || '';
            document.getElementById('editKwiatomat').checked = product.kwiatomatAvailable;
            document.getElementById('editType').value = product.type || '';
            document.getElementById('editCategory').value = product.category || 'occasional';

            // PodglƒÖd i ≈õcie≈ºka zdjƒôcia
            document.getElementById('editPreviewImage').src = product.image || '';
            document.getElementById('editImagePath').value = product.image || '';
            document.getElementById('editPreviewName').textContent = product.name;
            document.getElementById('editPreviewType').textContent = typeLabels[product.type] || product.type;

            // Tagi quizu
            const quizSection = document.getElementById('quizTagsSection');
            if (product.category === 'occasional') {
                quizSection.style.display = 'block';
                if (product.quizTags) {
                    // Pomocnicza funkcja do ustawiania multi-select
                    function setMultiSelect(selectId, value) {
                        const select = document.getElementById(selectId);
                        const values = Array.isArray(value) ? value : (value ? [value] : []);
                        Array.from(select.options).forEach(opt => {
                            opt.selected = values.includes(opt.value);
                        });
                    }
                    setMultiSelect('editOccasion', product.quizTags.occasion);
                    setMultiSelect('editPersonality', product.quizTags.personality);
                    setMultiSelect('editPriority', product.quizTags.priority);
                    setMultiSelect('editColor', product.quizTags.color);
                } else {
                    // Resetuj wszystkie selecty
                    ['editOccasion', 'editPersonality', 'editPriority', 'editColor'].forEach(id => {
                        Array.from(document.getElementById(id).options).forEach(opt => opt.selected = false);
                    });
                }
            } else {
                quizSection.style.display = 'none';
            }

            // Nas≈Çuchuj zmiany kategorii
            document.getElementById('editCategory').onchange = function() {
                document.getElementById('quizTagsSection').style.display =
                    this.value === 'occasional' ? 'block' : 'none';
            };

            // Reset inputa pliku
            document.getElementById('editImageFile').value = '';

            // Poka≈º modal
            document.getElementById('editModal').classList.add('show');
        }

        // Zamknij modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        // Zapisz produkt (nowy lub edytowany)
        function saveProduct(event) {
            event.preventDefault();

            const id = parseInt(document.getElementById('editProductId').value);
            const name = document.getElementById('editName').value.trim();
            const price = parseInt(document.getElementById('editPrice').value) || 0;

            // Walidacja
            if (!name) {
                alert('Podaj nazwƒô produktu!');
                return;
            }
            if (price <= 0) {
                alert('Podaj prawid≈ÇowƒÖ cenƒô!');
                return;
            }

            const index = allProducts.findIndex(p => p.id === id);
            const isNew = index === -1;

            // Pomocnicza funkcja do pobierania warto≈õci z multi-select
            function getMultiSelectValues(selectId) {
                const select = document.getElementById(selectId);
                return Array.from(select.selectedOptions).map(opt => opt.value);
            }

            // Zbierz dane produktu
            const productData = {
                id: id,
                name: name,
                price: price,
                description: document.getElementById('editDescription').value,
                kwiatomatAvailable: document.getElementById('editKwiatomat').checked,
                image: document.getElementById('editImagePath').value,
                type: document.getElementById('editType').value,
                category: document.getElementById('editCategory').value
            };

            // Tagi quizu (tylko dla okoliczno≈õciowych)
            if (productData.category === 'occasional') {
                productData.quizTags = {
                    occasion: getMultiSelectValues('editOccasion'),
                    personality: getMultiSelectValues('editPersonality'),
                    priority: getMultiSelectValues('editPriority'),
                    color: getMultiSelectValues('editColor')
                };
            }

            if (isNew) {
                // Dodaj nowy produkt
                allProducts.push(productData);
            } else {
                // Aktualizuj istniejƒÖcy
                allProducts[index] = productData;
            }

            // Zapisz i od≈õwie≈º
            saveToLocalStorage();
            updateStats();
            updateTypeFilter();
            renderProducts();
            closeEditModal();

            alert(isNew ? 'Produkt dodany!' : 'Produkt zapisany!');
        }

        // Usu≈Ñ produkt
        function deleteProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;

            if (!confirm(`Czy na pewno chcesz usunƒÖƒá produkt "${product.name}"?\n\nTa operacja jest nieodwracalna!`)) return;

            allProducts = allProducts.filter(p => p.id !== id);

            saveToLocalStorage();
            updateStats();
            updateTypeFilter();
            renderProducts();

            alert('Produkt usuniƒôty!');
        }

        // Aktualizuj statystyki
        function updateStats() {
            document.getElementById('totalProducts').textContent = allProducts.length;
            document.getElementById('occasionalProducts').textContent =
                allProducts.filter(p => p.category === 'occasional').length;
            document.getElementById('funeralProducts').textContent =
                allProducts.filter(p => p.category === 'funeral').length;
            document.getElementById('kwiatomatProducts').textContent =
                allProducts.filter(p => p.kwiatomatAvailable).length;
        }

        // Resetuj produkty do domy≈õlnych
        function resetProducts() {
            if (!confirm('Czy na pewno chcesz zresetowaƒá wszystkie produkty do warto≈õci domy≈õlnych?\n\nTo usunie wszystkie Twoje zmiany!')) return;

            localStorage.removeItem('liliaProducts');
            localStorage.removeItem('liliaProductsVersion');
            allProducts = getProducts();
            saveToLocalStorage();
            updateStats();
            updateTypeFilter();
            renderProducts();

            alert('Produkty zresetowane do warto≈õci domy≈õlnych!');
        }

        // Eksportuj produkty
        function exportProducts() {
            const dataStr = JSON.stringify(allProducts, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'lilia-produkty-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
        }

        // Zamykanie modalu klawiszem ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditModal();
            }
        });

        // Zamykanie modalu po klikniƒôciu w t≈Ço
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
    <script src="assets/js/scripts.js"></script>
</body>
</html>
